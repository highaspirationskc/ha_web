<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
  <div class="px-4 py-6 sm:px-0">
    <div class="flex justify-between items-center mb-6">
      <nav class="flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
          <li class="inline-flex items-center">
            <%= link_to admin_users_path, class: "inline-flex items-center text-sm font-medium text-gray-700 hover:text-indigo-600" do %>
              Users
            <% end %>
          </li>
          <li aria-current="page">
            <div class="flex items-center">
              <svg class="w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
              </svg>
              <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2"><%= @user.email %></span>
            </div>
          </li>
        </ol>
      </nav>
      <div class="flex space-x-4">
        <%= link_to "Edit", edit_admin_user_path(@user), class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200" %>
        <% if real_current_user.admin? && @user != real_current_user %>
          <%= button_to "Spoof User", admin_spoof_path(@user), method: :post, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-500 hover:bg-yellow-600" %>
        <% end %>
        <% if @can_activate_deactivate %>
          <% if @user.active? %>
            <%= button_to "Deactivate", deactivate_admin_user_path(@user), method: :patch, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700", data: { confirm: "Are you sure?" } %>
          <% else %>
            <%= button_to "Activate", activate_admin_user_path(@user), method: :patch, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700" %>
          <% end %>
        <% end %>
        <% if @can_delete %>
          <%= button_to "Delete User", admin_user_path(@user), method: :delete, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700", data: { confirm: "Are you sure?" } %>
        <% end %>
      </div>
    </div>

    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
      <div class="px-4 py-5 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900">User Information</h3>
      </div>
      <div class="border-t border-gray-200">
        <dl>
          <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">Name</dt>
            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"><%= @user.first_name %> <%= @user.last_name %></dd>
          </div>
          <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">Email</dt>
            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"><%= @user.email %></dd>
          </div>
          <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">Role</dt>
            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"><%= @user.role_name %></dd>
          </div>
          <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">Status</dt>
            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
              <% if @user.active? %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>
              <% else %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Inactive</span>
              <% end %>
            </dd>
          </div>
          <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500">Created</dt>
            <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2"><%= @user.created_at.strftime("%B %d, %Y at %I:%M %p") %></dd>
          </div>
          <% if @user.mentee.present? %>
            <div class="bg-white px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-gray-500">Team</dt>
              <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                <% if @user.mentee.team.present? %>
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-<%= @user.mentee.team.color %>-100 text-<%= @user.mentee.team.color %>-800">
                    <%= @user.mentee.team.name %>
                  </span>
                <% else %>
                  <span class="text-gray-500">Unassigned</span>
                <% end %>
              </dd>
            </div>
            <div class="bg-gray-50 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-gray-500">Mentor</dt>
              <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">
                <% if @user.mentee.mentor.present? %>
                  <%= link_to admin_user_path(@user.mentee.mentor.user), class: "text-indigo-600 hover:text-indigo-900" do %>
                    <%= @user.mentee.mentor.user.first_name %> <%= @user.mentee.mentor.user.last_name %>
                  <% end %>
                  <div class="text-sm text-gray-500"><%= @user.mentee.mentor.user.email %></div>
                <% else %>
                  <span class="text-gray-500">Unassigned</span>
                <% end %>
              </dd>
            </div>
          <% end %>
        </dl>
      </div>
    </div>

    <!-- Mentees (only for mentors) -->
    <% if @user.mentor.present? %>
    <div class="mt-6">
      <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
        Mentees (<%= @user.mentor.mentees.count %>)
      </h3>

      <!-- Add Mentee Form -->
      <% if @can_manage_mentees %>
        <div class="mb-4 bg-white shadow sm:rounded-lg p-4">
          <h4 class="text-sm font-medium text-gray-700 mb-3">Add Mentee</h4>
          <% if @available_mentees_for_mentor.any? %>
            <%= form_with url: add_mentee_admin_user_path(@user), method: :post, class: "flex items-end space-x-4" do |f| %>
              <div class="flex-grow">
                <%= render "admin/shared/combobox",
                    name: "mentee_id",
                    label: "Select Mentee",
                    options: @available_mentees_for_mentor.map { |m| ["#{m.user.first_name} #{m.user.last_name} (#{m.user.email})", m.id] },
                    placeholder: "Search mentees..." %>
              </div>
              <%= f.submit "Add", class: "inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 cursor-pointer" %>
            <% end %>
          <% else %>
            <p class="text-sm text-gray-500">No unassigned mentees available.</p>
          <% end %>
        </div>
      <% end %>

      <div class="flex flex-col">
        <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
          <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
            <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Mentee
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Team
                    </th>
                    <% if @can_manage_mentees %>
                      <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Actions
                      </th>
                    <% end %>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <% if @user.mentor.mentees.any? %>
                    <% @user.mentor.mentees.includes(:user, :team).each do |mentee| %>
                      <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <%= link_to admin_user_path(mentee.user), class: "text-sm font-medium text-indigo-600 hover:text-indigo-900" do %>
                            <%= mentee.user.first_name %> <%= mentee.user.last_name %>
                          <% end %>
                          <div class="text-sm text-gray-500"><%= mentee.user.email %></div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <% if mentee.team.present? %>
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-<%= mentee.team.color %>-100 text-<%= mentee.team.color %>-800">
                              <%= mentee.team.name %>
                            </span>
                          <% else %>
                            <span class="text-sm text-gray-500">Unassigned</span>
                          <% end %>
                        </td>
                        <% if @can_manage_mentees %>
                          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <%= button_to "Remove", remove_mentee_admin_user_path(@user, mentee_id: mentee.id), method: :delete, class: "text-red-600 hover:text-red-900", data: { confirm: "Are you sure you want to remove this mentee from this mentor?" } %>
                          </td>
                        <% end %>
                      </tr>
                    <% end %>
                  <% else %>
                    <tr>
                      <td colspan="<%= @can_manage_mentees ? 3 : 2 %>" class="px-6 py-4 text-center text-sm text-gray-500">No mentees assigned</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% end %>

    <!-- Family Members (only for mentees) -->
    <% if @user.mentee.present? %>
    <div class="mt-6">
      <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
        Guardians (<%= @user.mentee.guardians.count %>)
      </h3>

      <!-- Add Guardian Form -->
      <% if @can_manage_family_members %>
        <div class="mb-4 bg-white shadow sm:rounded-lg p-4" data-controller="modal">
          <div class="flex justify-between items-center mb-3">
            <h4 class="text-sm font-medium text-gray-700">Add Guardian</h4>
            <button type="button"
                    data-action="click->modal#open"
                    class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200">
              + Create New Guardian
            </button>
          </div>
          <% if @available_guardians_for_family.any? %>
            <%= form_with url: add_family_member_admin_user_path(@user), method: :post, class: "flex items-end space-x-4" do |f| %>
              <div class="flex-grow">
                <%= render "admin/shared/combobox",
                    name: "guardian_user_id",
                    label: "Select Existing Guardian",
                    options: @available_guardians_for_family.map { |g| ["#{g.user.first_name} #{g.user.last_name} (#{g.user.email})", g.user.id] },
                    placeholder: "Search guardians..." %>
              </div>
              <div class="w-48">
                <%= label_tag :relationship_type, "Relationship", class: "block text-sm font-medium text-gray-700" %>
                <%= select_tag :relationship_type, options_for_select(@allowed_relationship_types), class: "mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
              </div>
              <%= f.submit "Add", class: "inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 cursor-pointer" %>
            <% end %>
          <% else %>
            <p class="text-sm text-gray-500">No existing guardians available. Create a new guardian using the button above.</p>
          <% end %>

          <!-- New Guardian Modal -->
          <div data-modal-target="dialog" class="hidden fixed inset-0 z-50">
            <div data-modal-target="backdrop"
                 data-action="click->modal#closeOnBackdrop"
                 class="fixed inset-0 bg-black/50 transition-opacity"></div>

            <div class="fixed inset-0 z-10 overflow-y-auto">
              <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                  <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Create New Guardian</h3>
                    <p class="text-sm text-gray-500 mb-4">The guardian will receive an email to confirm their account and set a password.</p>

                    <%= form_with url: create_guardian_admin_user_path(@user), method: :post, class: "space-y-4", data: { turbo: false } do |f| %>
                      <div>
                        <%= f.label :email, class: "block text-sm font-medium text-gray-700" %>
                        <%= f.email_field :email, required: true, class: "mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm", placeholder: "guardian@example.com" %>
                      </div>

                      <div class="grid grid-cols-2 gap-4">
                        <div>
                          <%= f.label :first_name, "First Name", class: "block text-sm font-medium text-gray-700" %>
                          <%= f.text_field :first_name, class: "mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
                        </div>
                        <div>
                          <%= f.label :last_name, "Last Name", class: "block text-sm font-medium text-gray-700" %>
                          <%= f.text_field :last_name, class: "mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
                        </div>
                      </div>

                      <div>
                        <%= f.label :relationship_type, "Relationship to Child", class: "block text-sm font-medium text-gray-700" %>
                        <%= f.select :relationship_type, @allowed_relationship_types, {}, class: "mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
                      </div>

                      <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                        <%= f.submit "Create Guardian", class: "inline-flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 sm:col-start-2 cursor-pointer" %>
                        <button type="button"
                                data-action="click->modal#close"
                                class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0">
                          Cancel
                        </button>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <div class="flex flex-col">
        <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
          <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
            <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Guardian
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Relationship
                    </th>
                    <% if @can_manage_family_members %>
                      <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Actions
                      </th>
                    <% end %>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <% if @user.mentee.family_members.any? %>
                    <% @user.mentee.family_members.includes(guardian: :user).each do |family_member| %>
                      <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <%= link_to family_member.guardian.user.email, admin_user_path(family_member.guardian.user), class: "text-sm font-medium text-indigo-600 hover:text-indigo-900" %>
                          <div class="text-sm text-gray-500">
                            <%= family_member.guardian.user.first_name %> <%= family_member.guardian.user.last_name %>
                          </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            <%= family_member.relationship_type.titleize %>
                          </span>
                        </td>
                        <% if @can_manage_family_members %>
                          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <%= button_to "Remove", remove_family_member_admin_user_path(@user, family_member_id: family_member.id), method: :delete, class: "text-red-600 hover:text-red-900", data: { confirm: "Are you sure you want to remove this guardian?" } %>
                          </td>
                        <% end %>
                      </tr>
                    <% end %>
                  <% else %>
                    <tr>
                      <td colspan="<%= @can_manage_family_members ? 3 : 2 %>" class="px-6 py-4 text-center text-sm text-gray-500">No guardians</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% end %>
  </div>
</div>
